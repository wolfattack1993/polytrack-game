<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0a192f; /* Dark Navy Blue */
            color: #ffffff;
            overflow: hidden;
            transition: background-color 0.3s ease; /* Add transition for smooth color change */
        }
        .title-glow {
            font-family: 'Press Start 2P', cursive;
            color: #e6f7ff;
            text-shadow:
                0 0 7px #00b8ff,
                0 0 10px #00b8ff,
                0 0 21px #00b8ff,
                0 0 42px #00b8ff,
                0 0 82px #00b8ff,
                0 0 92px #00b8ff,
                0 0 102px #00b8ff,
                0 0 151px #00b8ff;
        }
        .auth-form-container {
            background-color: rgba(23, 42, 69, 0.8);
            border: 2px solid #304a6e;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            position: relative; /* Needed for positioning the admin trigger */
        }
        .auth-input {
            background-color: #0a192f;
            border: 2px solid #304a6e;
            color: #e6f7ff;
        }
        .auth-button {
             background-color: #304a6e;
             border: 2px solid #5691c8;
             transition: background-color 0.2s;
        }
        .auth-button:hover {
            background-color: #5691c8;
        }
        .menu-btn {
            background-color: #172a45; /* Darker Button Color */
            border: 2px solid #304a6e;
            width: 120px;
            height: 100px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            color: #a8b2d1;
        }
        .menu-btn:hover, .menu-btn.active {
            background-color: #304a6e;
            border-color: #5691c8;
            color: #e6f7ff;
        }
        .menu-btn svg {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
        }
        .icon-btn {
            background-color: #172a45;
            border: 2px solid #304a6e;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
        }
        .icon-btn:hover {
             background-color: #304a6e;
        }
         .icon-btn:disabled {
            background-color: #1a243a;
            border-color: #2a3a5a;
            cursor: not-allowed;
        }
         .icon-btn svg {
            width: 24px;
            height: 24px;
        }

        #right-palette {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 16px;
            background-color: rgba(10, 25, 47, 0.8);
            border: 2px solid #304a6e;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        #right-palette .block-item {
            width: 60px;
            height: 60px;
            background-color: #172a45;
            border: 2px solid #304a6e;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        #right-palette .block-item.selected {
            border-color: #5691c8;
            background-color: #304a6e;
        }

        #right-palette .block-item .block-preview {
            background-color: #a8b2d1; /* Default straight color */
            position: relative;
        }
        #right-palette .block-item .block-preview-straight { width: 80%; height: 20%;}
        #right-palette .block-item .block-preview-corner { width: 50%; height: 50%; border-top: 5px solid #a8b2d1; border-left: 5px solid #a8b2d1; background: none; position: absolute; top: 25%; left: 25%;}
        #right-palette .block-item .block-preview-ramp { width: 80%; height: 40%; clip-path: polygon(0 100%, 100% 0, 100% 100%); }

         #top-toolbar {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
            background-color: rgba(10, 25, 47, 0.8);
            padding: 8px;
            border-radius: 8px;
            border: 2px solid #304a6e;
        }
        .color-picker-panel {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(10, 25, 47, 0.8);
            border: 2px solid #304a6e;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }
        .color-picker-panel label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .color-picker-panel input[type="color"] {
            -webkit-appearance: none;
            width: 50px;
            height: 50px;
            border: none;
            cursor: pointer;
            border-radius: 50%;
        }
        .color-picker-panel input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker-panel input[type="color"]::-webkit-color-swatch {
            border: 2px solid #5691c8;
            border-radius: 50%;
        }
        .settings-color-picker {
            -webkit-appearance: none;
            width: 50px;
            height: 50px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            border: 2px solid #5691c8;
        }
        .settings-color-picker::-webkit-color-swatch-wrapper { padding: 0; }
        .settings-color-picker::-webkit-color-swatch { border: none; border-radius: 6px; }

        /* Admin Panel Styles */
        #admin-code-trigger {
            position: absolute;
            bottom: 2px;
            right: 5px;
            font-size: 0.6rem;
            color: #4a5568; /* Dark Gray */
            cursor: pointer;
            user-select: none;
        }
        #admin-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }
        #admin-broadcast-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 8px;
            z-index: 50;
        }
    </style>
</head>
<body class="w-screen h-screen">

    <!-- 3D Canvas -->
    <canvas id="bg-canvas" class="absolute top-0 left-0 w-full h-full z-0"></canvas>

    <!-- UI Views -->
    <div id="ui-container" class="absolute top-0 left-0 w-full h-full z-10 p-4 sm:p-8 flex items-center justify-center">

        <!-- Auth UI -->
        <div id="auth-ui" class="hidden">
            <div class="auth-form-container">
                <!-- Login Form -->
                <form id="login-form">
                    <h2 class="text-3xl text-center mb-6 text-cyan-300">Login</h2>
                    <input id="login-email" type="email" placeholder="Email" class="w-full p-2 mb-4 rounded auth-input" required>
                    <input id="login-password" type="password" placeholder="Password" class="w-full p-2 mb-4 rounded auth-input" required>
                    <button type="submit" class="w-full p-2 rounded auth-button">Login</button>
                    <p id="login-error" class="text-red-400 text-center mt-2"></p>
                    <p class="text-center mt-4">
                        No account? <a href="#" id="show-signup" class="text-cyan-300 hover:underline">Sign Up</a>
                    </p>
                </form>

                <!-- Signup Form -->
                <form id="signup-form" class="hidden">
                    <h2 class="text-3xl text-center mb-6 text-cyan-300">Sign Up</h2>
                    <input id="signup-email" type="email" placeholder="Email" class="w-full p-2 mb-4 rounded auth-input" required>
                    <input id="signup-password" type="password" placeholder="Password" class="w-full p-2 mb-4 rounded auth-input" required>
                    <button type="submit" class="w-full p-2 rounded auth-button">Sign Up</button>
                    <p id="signup-error" class="text-red-400 text-center mt-2"></p>
                    <p class="text-center mt-4">
                        Already have an account? <a href="#" id="show-login" class="text-cyan-300 hover:underline">Login</a>
                    </p>
                </form>
                
                 <button id="guest-btn" class="w-full p-2 mt-4 rounded auth-button bg-gray-600 border-gray-500">Continue as Guest</button>

                 <span id="admin-code-trigger">Insert Code</span>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="main-menu" class="hidden text-center">
            <div id="user-info" class="absolute top-4 right-4 text-right">
                <p id="user-email" class="text-cyan-300"></p>
                <button id="logout-btn" class="icon-btn px-4 py-2 mt-1">Logout</button>
            </div>

            <h1 class="text-8xl font-bold tracking-wider mb-12 title-glow">PolyTrack</h1>
            <div class="flex flex-row space-x-4">
                <button id="customize-btn" class="menu-btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span>Customize</span>
                </button>
                 <button id="editor-btn" class="menu-btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"></path></svg>
                    <span>Editor</span>
                </button>
                 <button id="settings-btn" class="menu-btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>Settings</span>
                </button>
                <button id="profile-btn" class="menu-btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>Profile</span>
                </button>
                <button id="play-btn" class="menu-btn">
                     <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>Play</span>
                </button>
            </div>
             <div class="mt-8">
                <input id="track-id-input" type="text" placeholder="Enter Track ID to load" class="bg-gray-800 border-2 border-cyan-400 text-yellow-300 p-2 text-center rounded">
                <button id="load-track-btn" class="icon-btn px-4 py-2 ml-2">Load</button>
            </div>
        </div>

        <!-- Builder UI -->
        <div id="builder-ui" class="hidden w-full h-full">
            <div id="top-toolbar">
                 <button id="builder-save-btn" class="icon-btn" title="Save">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                 </button>
                 <button id="builder-race-btn" class="icon-btn" title="Test Race">
                     <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                 </button>
                 <button id="builder-exit-btn" class="icon-btn" title="Exit">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                 </button>
            </div>
            <div id="right-palette">
                <!-- Blocks will be populated by JS -->
            </div>
            <div class="absolute bottom-4 left-4 glass-panel p-2 rounded-lg text-center">
                <p>Track ID</p>
                <p id="builder-track-id" class="text-yellow-300">-</p>
            </div>
        </div>

        <!-- Race UI -->
        <div id="race-ui" class="hidden w-full h-full">
            <div id="admin-broadcast-bar" class="hidden">
                <div id="admin-message-display" class="h-24 overflow-y-auto text-sm mb-2 p-1 bg-black bg-opacity-20 rounded"></div>
                <form id="admin-message-form" class="flex">
                    <input type="text" id="admin-message-input" class="auth-input flex-grow p-1 text-sm" placeholder="Admin Broadcast...">
                    <button type="submit" class="auth-button p-1 ml-2">Send</button>
                </form>
            </div>

            <div class="absolute top-4 left-4 glass-panel p-4 rounded-lg">
                <h2 class="text-2xl">TIME</h2>
                <p id="timer" class="text-4xl text-yellow-300">0.00</p>
            </div>
             <div class="absolute top-4 right-4 flex flex-col space-y-2">
                <button id="race-exit-btn" class="icon-btn px-4 py-2">Exit</button>
            </div>
            <div id="race-message" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-6xl text-center hidden">
                <p id="race-message-text"></p>
            </div>
        </div>
        
        <!-- Customize UI -->
        <div id="customize-ui" class="hidden w-full h-full flex flex-col items-center justify-center">
             <h1 class="text-6xl font-bold tracking-wider mb-12 title-glow">Customize Car</h1>
             <div id="top-toolbar">
                  <button id="customize-exit-btn" class="icon-btn" title="Back to Menu">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                 </button>
             </div>
             <div class="color-picker-panel">
                <label>
                    Body
                    <input type="color" id="body-color-picker" value="#ff0000">
                </label>
                <label>
                    Cabin
                    <input type="color" id="cabin-color-picker" value="#000000">
                </label>
             </div>
        </div>

        <!-- Settings UI -->
        <div id="settings-ui" class="hidden w-full h-full flex flex-col items-center justify-center">
            <h1 class="text-6xl font-bold tracking-wider mb-12 title-glow">Settings</h1>
            <div id="top-toolbar">
                 <button id="settings-exit-btn" class="icon-btn" title="Back to Menu">
                   <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                </button>
            </div>
            <div class="auth-form-container">
               <h2 class="text-2xl text-center mb-6 text-cyan-300">Appearance</h2>
               <div class="flex justify-between items-center">
                   <label for="bg-color-picker" class="text-lg">Menu Background</label>
                   <input type="color" id="bg-color-picker" class="settings-color-picker" value="#0a192f">
               </div>
            </div>
       </div>

    </div>
    
    <!-- Admin Code Modal -->
    <div id="admin-modal" class="hidden">
        <div class="auth-form-container">
            <h2 class="text-2xl text-center mb-4 text-cyan-300">Enter Admin Code</h2>
            <input id="admin-code-input" type="password" class="w-full p-2 mb-4 rounded auth-input">
            <button id="admin-code-submit" class="w-full p-2 rounded auth-button mb-2">Submit</button>
            <button id="admin-modal-close" class="w-full p-2 rounded auth-button bg-red-700 border-red-500">Close</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
        import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Global State ---
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'retro-racer-default';
        let isAdmin = false;

        // --- Firebase Setup ---
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, user => {
                if (user) {
                    // User is signed in.
                    console.log("User signed in:", user.uid);
                    document.getElementById('user-email').textContent = user.isAnonymous ? 'Guest' : user.email;
                    document.getElementById('logout-btn').classList.toggle('hidden', user.isAnonymous);
                    initMenu();
                } else {
                    // User is signed out.
                    console.log("User signed out.");
                    initAuth();
                }
            });
        } catch (e) {
            console.error("Firebase config not found or invalid. Switching to offline mode.", e);
            // If Firebase fails, go to the main menu but in an "offline" state.
            initMenu();
            document.getElementById('user-info').innerHTML = '<p class="text-red-400">Offline Mode</p>';
            document.getElementById('builder-save-btn').disabled = true;
            document.getElementById('load-track-btn').disabled = true;
            document.getElementById('track-id-input').placeholder = "Online features disabled";
            document.getElementById('track-id-input').disabled = true;

        }

        async function saveTrack(trackData) {
            if (!db) {
                alert("Database not connected. Cannot save track.");
                return null;
            }
            try {
                // For simplicity, all tracks are public for now.
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/tracks`), {
                    data: JSON.stringify(trackData),
                    owner: auth.currentUser ? auth.currentUser.uid : 'anonymous'
                });
                console.log("Track saved with ID: ", docRef.id);
                return docRef.id;
            } catch (e) {
                console.error("Error saving track: ", e);
                return null;
            }
        }

        async function loadTrack(trackId) {
            if (!db) {
                alert("Database not connected. Cannot load track.");
                return null;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/tracks`, trackId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return JSON.parse(docSnap.data().data);
                } else {
                    console.log("No such track!");
                    alert("Track ID not found.");
                    return null;
                }
            } catch (e) {
                console.error("Error loading track: ", e);
                return null;
            }
        }

        // --- Basic Setup ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        const clearColorMenu = 0x0a192f;
        const clearColorBuilder = 0xcde0f0;
        renderer.setClearColor(clearColorMenu, 0); // Make it transparent for the body background to show

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- More Global State ---
        let controls;
        let currentState = 'AUTH'; // This will be quickly changed by the logic above.
        let cars = [];
        let playerCarIndex = 0;
        let gridHelper, plane;
        let trackObjects = new THREE.Group();
        scene.add(trackObjects);
        let raceStartTime = 0;
        let raceTimerInterval;
        let currentTrackId = null;
        let previewCar = null;
        let playerCarColors = {
            body: '#ff0000',
            cabin: '#000000'
        };

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let placementIndicator;

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
        dirLight.position.set(5, 10, 7.5);
        scene.add(dirLight);

        // --- Track Block Definitions ---
        const TILE_SIZE = 4;
        const TILE_HEIGHT = 0.2;
        const blockTypes = {
            'Start': { color: 0x00ff00, factory: createStraight },
            'Finish': { color: 0xff0000, factory: createStraight },
            'Straight': { color: 0x808080, factory: createStraight },
            'Corner': { color: 0x808080, factory: createCorner },
            'Ramp': { color: 0xff8c00, factory: createRamp }
        };

        function createBase(color) {
            const mat = new THREE.MeshStandardMaterial({ color });
            const geom = new THREE.BoxGeometry(TILE_SIZE, TILE_HEIGHT, TILE_SIZE);
            return new THREE.Mesh(geom, mat);
        }

        function createStraight() {
            const block = new THREE.Group();
            const base = createBase(this.color);
            block.add(base);
            return block;
        }

        function createCorner() {
            const block = new THREE.Group();
            const base = createBase(this.color);
            block.add(base);
             const postGeom = new THREE.CylinderGeometry(0.2, 0.2, 2, 8);
            const postMat = new THREE.MeshStandardMaterial({ color: 0xff0000 });
            const post = new THREE.Mesh(postGeom, postMat);
            post.position.set(TILE_SIZE/2 - 0.3, 1, TILE_SIZE/2 - 0.3);
            block.add(post);
            return block;
        }

        function createRamp() {
            const block = new THREE.Group();
            const shape = new THREE.Shape();
            shape.moveTo(0, 0);
            shape.lineTo(TILE_SIZE, 0);
            shape.lineTo(TILE_SIZE, TILE_SIZE/2);
            shape.lineTo(0, TILE_SIZE/2);
            shape.lineTo(0,0);
            const extrudeSettings = { depth: TILE_SIZE, bevelEnabled: false };
            const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
            const material = new THREE.MeshStandardMaterial({ color: this.color });
            const rampMesh = new THREE.Mesh(geometry, material);
            rampMesh.rotation.y = -Math.PI/2;
            rampMesh.position.set(-TILE_SIZE/2, TILE_HEIGHT/2, TILE_SIZE/2);
            block.add(rampMesh);
            return block;
        }
        
        const palette = document.getElementById('right-palette');
        Object.keys(blockTypes).forEach(name => {
            const item = document.createElement('div');
            item.className = 'block-item p-2 border-2 border-transparent cursor-pointer';
            item.dataset.type = name;
            item.title = name;

            const preview = document.createElement('div');
            preview.className = 'block-preview';
            
            if (name.includes('Straight') || name === 'Start' || name === 'Finish') {
                preview.classList.add('block-preview-straight');
                preview.style.backgroundColor = `#${new THREE.Color(blockTypes[name].color).getHexString()}`;
            } else if (name === 'Corner') {
                 preview.classList.add('block-preview-corner');
                 preview.style.borderColor = `#${new THREE.Color(blockTypes[name].color).getHexString()}`;
            } else if (name === 'Ramp') {
                 preview.classList.add('block-preview-ramp');
                 preview.style.backgroundColor = `#${new THREE.Color(blockTypes[name].color).getHexString()}`;
            }

            item.appendChild(preview);

            item.addEventListener('click', () => {
                document.querySelectorAll('.block-item').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
            });
            palette.appendChild(item);
        });
        palette.children[0]?.classList.add('selected');


        // --- Car ---
        function createCar(colors) {
            const carGroup = new THREE.Group();
            
            const bodyMat = new THREE.MeshStandardMaterial({ color: colors.body, roughness: 0.3 });
            const bodyGeom = new THREE.BoxGeometry(1.5, 0.8, 3);
            const body = new THREE.Mesh(bodyGeom, bodyMat);
            body.position.y = 0.8;
            carGroup.add(body);

            const cabinMat = new THREE.MeshStandardMaterial({ color: colors.cabin });
            const cabinGeom = new THREE.BoxGeometry(1.3, 0.6, 1.5);
            const cabin = new THREE.Mesh(cabinGeom, cabinMat);
            cabin.position.set(0, 1.5, -0.2);
            carGroup.add(cabin);
            
            carGroup.userData.velocity = new THREE.Vector3();
            carGroup.userData.steering = 0;

            return carGroup;
        }

        // --- UI Switching ---
        const views = {
            'AUTH': document.getElementById('auth-ui'),
            'MENU': document.getElementById('main-menu'),
            'BUILDER': document.getElementById('builder-ui'),
            'RACE': document.getElementById('race-ui'),
            'CUSTOMIZE': document.getElementById('customize-ui'),
            'SETTINGS': document.getElementById('settings-ui'),
        };

        function switchUi(state) {
            currentState = state;
            Object.values(views).forEach(v => v.classList.add('hidden'));
            if (views[state]) {
                views[state].classList.remove('hidden');
            }
        }
        
        // --- Modes ---
        function initAuth() {
            switchUi('AUTH');
        }

        function initMenu() {
            switchUi('MENU');
            camera.position.set(10, 10, 15);
            camera.lookAt(0, 0, 0);
            renderer.setClearColor(clearColorMenu, 0);
            if (controls) {
                controls.dispose();
                controls = null;
            }
        }
        
        function initBuilder() {
            switchUi('BUILDER');
            camera.position.set(0, 30, 0);
            camera.lookAt(0, 0, 0);
            renderer.setClearColor(clearColorBuilder, 1);
            
            if (controls) controls.dispose();
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.1;

            plane = new THREE.Mesh(
                new THREE.PlaneGeometry(500, 500),
                new THREE.MeshBasicMaterial({ color: 0x0000ff, visible: false })
            );
            plane.rotation.x = -Math.PI / 2;
            scene.add(plane);

            gridHelper = new THREE.GridHelper(500, 500/TILE_SIZE);
            scene.add(gridHelper);
            
            const indicatorGeom = new THREE.BoxGeometry(TILE_SIZE, TILE_HEIGHT, TILE_SIZE);
            const indicatorMat = new THREE.MeshBasicMaterial({ color: 0xffff00, wireframe: true });
            placementIndicator = new THREE.Mesh(indicatorGeom, indicatorMat);
            scene.add(placementIndicator);
        }

        function exitBuilder() {
            if (plane) scene.remove(plane);
            if (gridHelper) scene.remove(gridHelper);
            if (placementIndicator) scene.remove(placementIndicator);
            plane = null;
            gridHelper = null;
            placementIndicator = null;
            clearTrack();
            renderer.setClearColor(clearColorMenu, 0);
            initMenu();
        }

        async function initRace(trackData) {
            switchUi('RACE');
            renderer.setClearColor(clearColorBuilder, 1);
            if (controls) {
                controls.dispose();
                controls = null;
            }
            
            clearTrack();
            if (trackData) {
                buildTrackFromData(trackData);
            } else {
                buildDemoTrack();
            }
            
            // Show admin bar if admin
            document.getElementById('admin-broadcast-bar').classList.toggle('hidden', !isAdmin);

            cars.forEach(car => scene.remove(car));
            cars = [];

            const startBlock = trackObjects.children.find(b => b.userData.type === 'Start');
            const startPosition = startBlock ? startBlock.position.clone() : new THREE.Vector3(0,0,0);
            const startRotation = startBlock ? startBlock.rotation.clone() : new THREE.Euler(0,0,0);

            // Create Player Car with custom colors
            const playerCar = createCar(playerCarColors);
            playerCar.position.copy(startPosition);
            playerCar.position.y = 1.0;
            playerCar.rotation.copy(startRotation);
            cars.push(playerCar);
            scene.add(playerCar);
            
            showMessage("3", 500, () => showMessage("2", 500, () => showMessage("1", 500, () => showMessage("GO!", 500, startRace))));
        }
        
        function initCustomize() {
            switchUi('CUSTOMIZE');
            renderer.setClearColor(clearColorMenu, 0);
            camera.position.set(0, 2, 8);
            camera.lookAt(0, 1, 0);

            if (controls) controls.dispose();
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1, 0);
            controls.enableDamping = true;
            controls.dampingFactor = 0.1;
            
            if (previewCar) scene.remove(previewCar);
            previewCar = createCar(playerCarColors);
            scene.add(previewCar);
        }

        function exitCustomize() {
            if (previewCar) scene.remove(previewCar);
            previewCar = null;
            initMenu();
        }

        function initSettings() {
            switchUi('SETTINGS');
            renderer.setClearColor(clearColorMenu, 0);
             if (controls) {
                controls.dispose();
                controls = null;
            }
        }

        function exitSettings() {
            initMenu();
        }


        function showMessage(text, duration, callback) {
            const msgEl = document.getElementById('race-message');
            const msgText = document.getElementById('race-message-text');
            msgText.textContent = text;
            msgEl.classList.remove('hidden');
            setTimeout(() => {
                msgEl.classList.add('hidden');
                if (callback) callback();
            }, duration);
        }

        function startRace() {
            raceStartTime = Date.now();
            raceTimerInterval = setInterval(() => {
                const elapsed = (Date.now() - raceStartTime) / 1000;
                document.getElementById('timer').textContent = elapsed.toFixed(2);
            }, 10);
        }

        function stopRace() {
            clearInterval(raceTimerInterval);
        }

        function exitRace() {
            stopRace();
            document.getElementById('admin-broadcast-bar').classList.add('hidden');
            cars.forEach(car => scene.remove(car));
            cars = [];
            clearTrack();
            initMenu();
        }

        // --- Track Building Logic ---
        function clearTrack() {
            while (trackObjects.children.length) {
                trackObjects.remove(trackObjects.children[0]);
            }
        }

        function buildTrackFromData(trackData) {
            clearTrack();
            trackData.forEach(blockInfo => {
                const blockType = blockTypes[blockInfo.type];
                if (blockType) {
                    const block = blockType.factory();
                    block.position.set(blockInfo.pos.x, blockInfo.pos.y, blockInfo.pos.z);
                    block.rotation.y = blockInfo.rot;
                    block.userData.type = blockInfo.type;
                    trackObjects.add(block);
                }
            });
        }
        
        function getTrackData() {
            return trackObjects.children.map(block => ({
                type: block.userData.type,
                pos: { x: block.position.x, y: block.position.y, z: block.position.z },
                rot: block.rotation.y
            }));
        }

        function buildDemoTrack() {
            const demoData = [
                {type: 'Start', pos: {x: 0, y: 0, z: 0}, rot: 0},
                {type: 'Straight', pos: {x: 0, y: 0, z: -4}, rot: 0},
                {type: 'Corner', pos: {x: 0, y: 0, z: -8}, rot: -1.5707963267948966},
                {type: 'Straight', pos: {x: -4, y: 0, z: -8}, rot: -1.5707963267948966},
                {type: 'Ramp', pos: {x: -8, y: 0, z: -8}, rot: -1.5707963267948966},
                {type: 'Straight', pos: {x: -12, y: 0, z: -8}, rot: -1.5707963267948966},
                {type: 'Corner', pos: {x: -16, y: 0, z: -8}, rot: -3.141592653589793},
                {type: 'Straight', pos: {x: -16, y: 0, z: -4}, rot: -3.141592653589793},
                {type: 'Corner', pos: {x: -16, y: 0, z: 0}, rot: 1.5707963267948966},
                {type: 'Straight', pos: {x: -12, y: 0, z: 0}, rot: 1.5707963267948966},
                {type: 'Straight', pos: {x: -8, y: 0, z: 0}, rot: 1.5707963267948966},
                {type: 'Corner', pos: {x: -4, y: 0, z: 0}, rot: 0},
            ];
            buildTrackFromData(demoData);
        }

        // --- Event Listeners ---

        // Auth Listeners
        document.getElementById('show-signup').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
        });
        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        });
        document.getElementById('guest-btn').addEventListener('click', () => {
            signInAnonymously(auth).catch(err => console.error(err));
        });
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(err => document.getElementById('login-error').textContent = err.message);
        });
        document.getElementById('signup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            createUserWithEmailAndPassword(auth, email, password)
                 .catch(err => document.getElementById('signup-error').textContent = err.message);
        });

        // Admin Panel Listeners
        const adminModal = document.getElementById('admin-modal');
        document.getElementById('admin-code-trigger').addEventListener('click', () => {
            adminModal.classList.remove('hidden');
        });
        document.getElementById('admin-modal-close').addEventListener('click', () => {
            adminModal.classList.add('hidden');
        });
        document.getElementById('admin-code-submit').addEventListener('click', () => {
            const codeInput = document.getElementById('admin-code-input');
            const SECRET_ADMIN_CODE = "Schdfm5083";
            if (codeInput.value === SECRET_ADMIN_CODE) {
                isAdmin = true;
                alert('Admin mode activated!');
                adminModal.classList.add('hidden');
            } else {
                alert('Incorrect code.');
            }
            codeInput.value = '';
        });
        document.getElementById('admin-message-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('admin-message-input');
            const message = input.value.trim();
            if (message) {
                const user = auth.currentUser;
                const username = user ? (user.isAnonymous ? 'Guest' : user.email.split('@')[0]) : 'Admin';
                const display = document.getElementById('admin-message-display');
                
                const messageEl = document.createElement('p');
                messageEl.innerHTML = `<span class="font-bold text-cyan-300">[${username}]</span>: ${message}`;
                display.appendChild(messageEl);
                display.scrollTop = display.scrollHeight; // Auto-scroll to bottom
                input.value = '';
            }
        });


        // Main Menu Listeners
        document.getElementById('editor-btn').addEventListener('click', () => initBuilder());
        document.getElementById('play-btn').addEventListener('click', () => initRace(null));
        document.getElementById('profile-btn').addEventListener('click', () => alert("Profile feature coming soon!"));
        document.getElementById('settings-btn').addEventListener('click', () => initSettings());
        document.getElementById('customize-btn').addEventListener('click', () => initCustomize());
        
        document.getElementById('customize-exit-btn').addEventListener('click', exitCustomize);
        document.getElementById('builder-exit-btn').addEventListener('click', exitBuilder);
        document.getElementById('race-exit-btn').addEventListener('click', exitRace);
        document.getElementById('settings-exit-btn').addEventListener('click', exitSettings);
        
        document.getElementById('builder-race-btn').addEventListener('click', () => {
             const trackData = getTrackData();
            if (trackData.length > 0) {
                 exitBuilder();
                 initRace(trackData);
            }
        });
        document.getElementById('builder-save-btn').addEventListener('click', async () => {
             const trackData = getTrackData();
             if(trackData.length === 0) {
                 alert("Track is empty!");
                 return;
             }
             const id = await saveTrack(trackData);
             if(id) {
                 currentTrackId = id;
                 document.getElementById('builder-track-id').textContent = id;
                 alert(`Track saved! Share this ID: ${id}`);
             }
        });
         document.getElementById('load-track-btn').addEventListener('click', async () => {
            const id = document.getElementById('track-id-input').value.trim();
            if (id) {
                const trackData = await loadTrack(id);
                if (trackData) {
                    currentTrackId = id;
                    initBuilder();
                    buildTrackFromData(trackData);
                    document.getElementById('builder-track-id').textContent = id;
                }
            } else {
                alert("Please enter a Track ID.");
            }
        });
        
        // Color Picker Listeners
        const bodyColorPicker = document.getElementById('body-color-picker');
        const cabinColorPicker = document.getElementById('cabin-color-picker');
        const bgColorPicker = document.getElementById('bg-color-picker');

        bodyColorPicker.addEventListener('input', (event) => {
            playerCarColors.body = event.target.value;
            if (previewCar) {
                previewCar.children[0].material.color.set(playerCarColors.body);
            }
        });
        cabinColorPicker.addEventListener('input', (event) => {
            playerCarColors.cabin = event.target.value;
            if (previewCar) {
                previewCar.children[1].material.color.set(playerCarColors.cabin);
            }
        });
        bgColorPicker.addEventListener('input', (event) => {
            document.body.style.backgroundColor = event.target.value;
        });


        const keyState = {};
        window.addEventListener('keydown', (e) => keyState[e.code] = true);
        window.addEventListener('keyup', (e) => keyState[e.code] = false);

        function updatePlayerCar(car, deltaTime) {
            const acceleration = 50.0;
            const friction = 0.97;
            const steeringSpeed = 2.5;
            const maxSpeed = 30.0;
            const maxSteering = 0.5;

            let { velocity, steering } = car.userData;

            let forwardSpeed = car.worldToLocal(car.position.clone().add(velocity)).z;
            
            if (keyState['ArrowUp'] || keyState['KeyW']) {
                velocity.add(car.getWorldDirection(new THREE.Vector3()).multiplyScalar(acceleration * deltaTime));
            }
            if (keyState['ArrowDown'] || keyState['KeyS']) {
                velocity.add(car.getWorldDirection(new THREE.Vector3()).multiplyScalar(-acceleration * deltaTime));
            }

            if (Math.abs(forwardSpeed) > 0.1) { 
                if (keyState['ArrowLeft'] || keyState['KeyA']) steering += steeringSpeed * deltaTime;
                if (keyState['ArrowRight'] || keyState['KeyD']) steering -= steeringSpeed * deltaTime;
            }
            
            steering *= 0.9;
            steering = Math.max(-maxSteering, Math.min(maxSteering, steering));
            
            car.rotation.y += steering * forwardSpeed * 0.03 * deltaTime;
            car.userData.steering = steering;
        }

        function updateCarPhysics(car, deltaTime) {
            const friction = 0.97;
            const maxSpeed = 30.0;
            let { velocity } = car.userData;

            velocity.multiplyScalar(friction);
            
            if (velocity.length() > maxSpeed) {
                velocity.normalize().multiplyScalar(maxSpeed);
            }

            car.position.add(velocity.clone().multiplyScalar(deltaTime));

            velocity.y -= 20.0 * deltaTime; // Gravity

            const carDown = new THREE.Vector3(0, -1, 0);
            raycaster.set(car.position, carDown);
            const intersects = raycaster.intersectObjects(trackObjects.children, true);
            
            if (intersects.length > 0 && intersects[0].distance < 1.1) {
                car.position.y = intersects[0].point.y + 1.0;
                velocity.y = 0;
            } else if (car.position.y < -10) {
                 if (cars.indexOf(car) === playerCarIndex) {
                    stopRace();
                    showMessage("FELL OFF!", 2000, exitRace);
                 } else {
                     const startBlock = trackObjects.children.find(b => b.userData.type === 'Start');
                     if (startBlock) {
                         car.position.copy(startBlock.position);
                         car.position.y = 1.0;
                         velocity.set(0,0,0);
                     }
                 }
            }
        }
        
        function updateBuilderInteraction() {
            if(!plane || !placementIndicator) return;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(plane);
            if (intersects.length > 0) {
                const intersectPoint = intersects[0].point;
                const gridX = Math.round(intersectPoint.x / TILE_SIZE);
                const gridZ = Math.round(intersectPoint.z / TILE_SIZE);
                placementIndicator.position.set(gridX * TILE_SIZE, 0, gridZ * TILE_SIZE);
                placementIndicator.visible = true;
            } else {
                placementIndicator.visible = false;
            }
        }
        
        function handleBuilderClick(event) {
            if (currentState !== 'BUILDER' || !placementIndicator.visible) return;
            
            const selectedType = document.querySelector('.block-item.selected')?.dataset.type;
            if (!selectedType) return;
            
            const blockType = blockTypes[selectedType];
            
             const existingBlock = trackObjects.children.find(b => b.position.equals(placementIndicator.position));
             if(event.button === 0 && existingBlock) return;

            if (event.button === 0) { // Left click
                const newBlock = blockType.factory();
                newBlock.position.copy(placementIndicator.position);
                newBlock.userData.type = selectedType;
                trackObjects.add(newBlock);
            } else if (event.button === 2) { // Right click
                if(existingBlock) {
                    trackObjects.remove(existingBlock);
                }
            }
        }
        
        function handleBuilderWheel(event) {
            if (currentState !== 'BUILDER' || !placementIndicator.visible) return;
             const existingBlock = trackObjects.children.find(b => b.position.equals(placementIndicator.position));
             if(existingBlock) {
                 const rotationAmount = Math.PI / 2;
                 existingBlock.rotation.y += Math.sign(event.deltaY) * rotationAmount;
             }
        }

        window.addEventListener('mousemove', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        });
        window.addEventListener('mousedown', handleBuilderClick);
        window.addEventListener('wheel', handleBuilderWheel);
        window.addEventListener('contextmenu', (e) => {
            if (currentState === 'BUILDER') e.preventDefault();
        });


        // --- Animate Loop ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const deltaTime = clock.getDelta();

            if (controls) {
                controls.update();
            }

            if (currentState === 'RACE' && raceStartTime > 0) {
                updatePlayerCar(cars[playerCarIndex], deltaTime);
                cars.forEach(car => updateCarPhysics(car, deltaTime));

                const playerCar = cars[playerCarIndex];
                const offset = new THREE.Vector3(0, 4, 8);
                const cameraPosition = playerCar.localToWorld(offset);
                camera.position.lerp(cameraPosition, 0.1);
                camera.lookAt(playerCar.position);
            }
            
            if (currentState === 'BUILDER') {
                updateBuilderInteraction();
            }
            
            if (currentState === 'CUSTOMIZE' && previewCar) {
                previewCar.rotation.y += 0.01;
            }

            renderer.render(scene, camera);
        }

        animate();

    </script>
</body>
</html>



